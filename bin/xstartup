#!/bin/sh
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
[ -r /etc/profile ] && source /etc/profile
[ -n "$BASH_ENV" ] && source "$BASH_ENV" 
command -v xdpyinfo >/dev/null 2>&1 && \
    geometry=`xdpyinfo | grep dimensions | awk '{print $2}'`

[ -r $HOME/.Xresources ] && \
    xrdb -merge $HOME/.Xresources
[ -r $HOME/.Xresources_$geometry ] && \
    xrdb -merge $HOME/.Xresources_$geometry

case $geometry in
    1440x900)
        geometry_set () {
            /usr/bin/xterm -geometry 110x66+0+0 &
        }
        ;;
    1920x1200)
        geometry_set () { 
            /usr/bin/xterm -geometry 100x43+0+0 &
        }
        ;;
    *)
        geometry_set () {
            case `hostname -s` in
                cp-loginy)
                    /usr/bin/xterm -geometry 110x66+0+0 &
                    ;;
                *)
                    /usr/bin/xterm -geometry +0+0 &
                    ;;
            esac
        }
        ;;
esac
[ -n "$SSH_ASKPASS" ] && ssh-add &
# this establishes a default windowing env. 
SSH_AGENT=$(which ssh-agent)
# The user may have their own clients they want to run.  If they don't,
# fall back to system defaults.
case "$VNC2HPC_WM" in
    fvwm)
        [ -x /usr/bin/xsetroot ] && /usr/bin/xsetroot -solid '#222E45'
        [ -x /usr/bin/vncconfig ] && /usr/bin/vncconfig -nowin &
        geometry_set
        [ -x /usr/projects/hpcsoft/common/fvwm/$(/usr/projects/hpcsoft/utilities/bin/sys_os)/$(/usr/projects/hpcsoft/utilities/bin/sys_arch)/2.6.9/bin/fvwm ] && /usr/projects/hpcsoft/common/fvwm/$(/usr/projects/hpcsoft/utilities/bin/sys_os)/$(/usr/projects/hpcsoft/utilities/bin/sys_arch)/2.6.9/bin/fvwm &
    ;;
    mwm)
        [ -x /usr/bin/xsetroot ] && /usr/bin/xsetroot -solid '#222E45'
        [ -x /usr/bin/vncconfig ] && /usr/bin/vncconfig -nowin &
        geometry_set
        [ -x /usr/bin/mwm ] && /usr/bin/mwm &
    ;; 
    openbox-session)
        #exec /etc/X11/xinit/xinitrc
        [ -x /usr/bin/xsetroot ] && /usr/bin/xsetroot -solid '#222E45'
        [ -x /usr/bin/vncconfig ] && /usr/bin/vncconfig -nowin &
        geometry_set
        module load mesa 
        [ -x /usr/projects/hpcsoft/common/openbox/$(/usr/projects/hpcsoft/utilities/bin/sys_os)/$(/usr/projects/hpcsoft/utilities/bin/sys_arch)/3.6.1/bin/openbox-session ] && /usr/projects/hpcsoft/common/openbox/$(/usr/projects/hpcsoft/utilities/bin/sys_os)/$(/usr/projects/hpcsoft/utilities/bin/sys_arch)/3.6.1/bin/openbox-session &
    ;;
    xfwm4)
        [ -x /usr/bin/xsetroot ] && /usr/bin/xsetroot -solid '#222E45'
        [ -x /usr/bin/vncconfig ] && /usr/bin/vncconfig -nowin &
        geometry_set
        [ -x /usr/bin/xfwm4 ] && /usr/bin/xfwm4 &
    ;;
    *)
        "echo UNSUPPORTED $1"
        exit 1 ;
    ;;
esac
